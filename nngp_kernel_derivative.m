
function [k, Lapx_k, Lapy_k, LapLap_k]=NN_err_fun_kernel_diff_exact_uploaded(X,Y,var_weight0,var_bias0,var_weight,var_bias,L)
 %%%% Iteratively compute the covariance matrices from
 %%%%   the NNGP kernel and its derivatives for solving
 %%%%   2D Poisson equation
 %%%%% The NNGP kernel from error-function nonlinearity:
 %%%%%        covariance -- k2 := k^l(x,x'); 
 %%%%%        variances --  k1  := k^l(x,x), k3: =k^l(x',x'),
 %%%%%        where the superscript "l" denotes index of layer, 
 %%%%%            and x and x' are two input vectors.
  
 %%%%%%%%%%%INPUT
 %%% X:  N1 by d_{in} matrix corresponding to input vector x, where d_{in} is
 %%%    the dimensionality of input space. 
 %%% Y:  N2 by d_{in} matrix corresponding to input vector x'
 %%% var_weight0: 1 by d_{in} vector, including variances of the weights 
 %%%                              between input and first hidden layers
 %%%                              (i.e. between layer 0 and layer 1)
 %%% var_bias0:   scalar, including variance of the bias between input and
 %%%                      first hidden layers
 %%% L:           number of hidden layers in the inducing neural net
 %%% var_weight: 1 by L vector, including the variances of weights 
 %%%            for layers 2,3,...,L+1
 
 %%%%%%%%%%%OUTPUT
 %%% k:  k^{L+1}(X,Y), covariance matrix for the output layer (layer L+1)
 %%% Lapx_k:  -\Delta_x k^{L+1}(X,Y) where 
 %%%      -\Delta_x:= -\partial/ \partial x1^2-\partial/\partial x2^2
 %%%        and x1 and x2 are two components of the input vector x
 %%% Lapy_k:  -\Delta_y k^{L+1}(X,Y) where 
 %%%      -\Delta_y:= -\partial/ \partial y1^2-\partial/\partial y2^2
 %%%        and y1 and y2 are two components of the input vector x'
 %%% LapLap_k:   \Delta_x\Delta_y k^{L+1}(X,Y)
 
 
 
 %%%%%%%%%%% written by Guofei Pang  June 20, 2018
 
 %%%%%  Notations for some variables
 %%%%%  k2x1:   first-order parital derivative of k(x,x') with respect to x1
 %%%%%  k1x1:   first-order partial derivative of k(x,x) over x1
 %%%%   k2x1y1: second-order partial derivative of k(x,x') over x1 and y1
    
 
 
 M=size(X,1);
 N=size(Y,1);
 
 
 
 %%% initializations for iteration
 
 k1= var_bias0+repmat(sum(repmat(var_weight0,M,1).*X.^2,2),1,N); 
 k2= var_bias0+(X*diag(var_weight0)*Y');
 k3 = var_bias0+repmat(sum(repmat(var_weight0,N,1).*Y.^2,2)',M,1);
 
 k1x1=2*var_weight0(1)*repmat(X(:,1),1,N);
 k2x1=var_weight0(1)*repmat(Y(:,1)',M,1);
 k1x1x1=2*var_weight0(1)*ones(M,N);
 k2x1x1=zeros(M,N);
 
 k1x2=2*var_weight0(2)*repmat(X(:,2),1,N);
 k2x2=var_weight0(2)*repmat(Y(:,2)',M,1);
 k1x2x2=2*var_weight0(2)*ones(M,N);
 k2x2x2=k2x1x1;
 
 k2y1=var_weight0(1)*repmat(X(:,1),1,N);
 k3y1=2*var_weight0(1)*repmat(Y(:,1)',M,1);
 k2y2=var_weight0(2)*repmat(X(:,2),1,N);
 k3y2=2*var_weight0(2)*repmat(Y(:,2)',M,1);
 
 k1x1y1=k2x1x1;
 k2x1y1=var_weight0(1)*ones(M,N);
 k2y1y1=k2x1x1;
 k3y1y1=k1x1x1;
 
 k1x1x1y1=k2x1x1;
 k1x1y1y1=k2x1x1;
 k2x1x1y1=k2x1x1;
 k2x1y1y1=k2x1x1;
 k1x1x1y1y1=k2x1x1;
 k2x1x1y1y1=k2x1x1;
 
 k1x1y2=k2x1x1;
 k2x1y2=k2x1x1;
 k2y2y2=k2x1x1;
 k3y2y2=k1x2x2;
 
 k1x1x1y2=k2x1x1;
 k1x1y2y2=k2x1x1;
 k2x1x1y2=k2x1x1;
 k2x1y2y2=k2x1x1;
 k1x1x1y2y2=k2x1x1;
 k2x1x1y2y2=k2x1x1;
 
 
 k1x2y1=k2x1x1;
 k2x2y1=k2x1x1;
 
 k1x2x2y1=k2x1x1;
 k1x2y1y1=k2x1x1;
 k2x2x2y1=k2x1x1;
 k2x2y1y1=k2x1x1;
 k1x2x2y1y1=k2x1x1;
 k2x2x2y1y1=k2x1x1;
 
 k1x2y2=k2x1x1;
 k2x2y2=var_weight0(2)*ones(M,N);

 k1x2x2y2=k2x1x1;
 k1x2y2y2=k2x1x1;
 k2x2x2y2=k2x1x1;
 k2x2y2y2=k2x1x1;
 k1x2x2y2y2=k2x1x1;
 k2x2x2y2y2=k2x1x1;


 for i=1:L
     sw=var_weight(i);
%%% iteration of covariances    
     k2x1x1y1y1=-(1./2).*sw.*(-(3./2.*(5.*(1+k1).^2.*k2.*k2x1.^2-k1x1.*(1+k1).*((1+k1).*k3+4.*k2.^2+k1+1).*k2x1-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).*k2.*k1x1x1+(3./4.*((1+k1).*k3+(2./3).*k2.^2+k1+1)).*k2.*k1x1.^2+((1+k1).*k3-k2.^2+k1+1).*(1+k1).^2.*k2x1x1)).*(1+k1).^2.*k3y1.^2+2.*(1+k1).^2.*((3.*(1+k1)).*((1+k1).*k3+4.*k2.^2+k1+1).*k2y1.*k2x1.^2+(-9.*k1x1.*((1+k1).*k3+(2./3).*k2.^2+k1+1).*k2.*k2y1-(((1+k1).*k3+2.*k2.^2+k1+1).*k1x1y1-6.*k2x1y1.*k2.*(1+k1)).*((1+k1).*k3-k2.^2+k1+1)).*k2x1+(-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k1).*k3+2.*k2.^2+k1+1).*k1x1x1+(3./4.*((1+k1).*k3+4.*k2.^2+k1+1)).*(1+k3).*k1x1.^2+(3.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).*k2.*k2x1x1).*k2y1+((1+k1).*k3-k2.^2+k1+1).*((3./2).*k2.*k1x1.*(1+k3).*k1x1y1-k1x1.*((1+k1).*k3+2.*k2.^2+k1+1).*k2x1y1+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k2x1x1y1-(1./2).*k2.*k1x1x1y1))).*k3y1-(2.*((9.*((1+k1).*k3+(2./3).*k2.^2+k1+1)).*k2.*k2y1.^2+((1+k1).*k3-k2.^2+k1+1).*(((1+k1).*k3+2.*k2.^2+k1+1).*k2y1y1-(3./2).*k3y1y1.*k2.*(1+k1)))).*(1+k1).^2.*k2x1.^2-(8.*(-(3./4).*k1x1.*((1+k1).*k3+4.*k2.^2+k1+1).*(1+k3).*k2y1.^2+(-(3./2).*k2.*(1+k3).*k1x1y1+k2x1y1.*((1+k1).*k3+2.*k2.^2+k1+1)).*((1+k1).*k3-k2.^2+k1+1).*k2y1+(1./8.*(-6.*k2.*k1x1.*(1+k3).*k2y1y1+k1x1.*((1+k1).*k3+2.*k2.^2+k1+1).*k3y1y1-(2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k3).*k1x1y1y1-2.*k2x1y1y1.*k2))).*((1+k1).*k3-k2.^2+k1+1))).*(1+k1).^2.*k2x1-(2.*(-(3./2.*((1+k1).*k3-k2.^2+k1+1)).*k2.*(1+k3).*k1x1x1+(15./4).*k2.*(1+k3).^2.*k1x1.^2+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k3+2.*k2.^2+k1+1).*k2x1x1)).*(1+k1).^2.*k2y1.^2+(2.*((1+k1).*k3-k2.^2+k1+1)).*(-3.*k1x1.*(1+k3).^2.*k1x1y1+6.*k2.*k1x1.*(1+k3).*k2x1y1+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k1x1x1y1-2.*k2x1x1y1.*k2)).*(1+k1).^2.*k2y1+(-(3.*((1+k1).*k3-k2.^2+k1+1)).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x1y1.^2+(4.*((1+k1).*k3-k2.^2+k1+1)).*k2x1y1.*(1+k1).^2.*(1+k3).*k1x1y1-(4.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).^2.*k2.*k2x1y1.^2-2.*(1+k1).^2.*(-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*(1+k3).*k1x1x1+(3./4).*(1+k3).^2.*k1x1.^2+((1+k1).*k3-k2.^2+k1+1).*k2.*k2x1x1).*k2y1y1-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*k3y1y1.*(1+k1).^2.*k2.*k1x1x1+((3./4).*k2.*(1+k3).*k1x1.^2+((1+k1).*k3-k2.^2+k1+1).*(1+k1).*k2x1x1).*(1+k1).^2.*k3y1y1-(2.*((1+k1).*k3-k2.^2+k1+1)).*(((3./2).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x1y1y1-k2x1y1y1.*(1+k3).*(1+k1).^2).*k1x1+((1+k1).*k2x1x1y1y1-(1./2).*k2.*k1x1x1y1y1).*((1+k1).*k3-k2.^2+k1+1).*(1+k1))).*((1+k1).*k3-k2.^2+k1+1))./(((1+k1).*k3-k2.^2+k1+1).^(7./2).*(1+k1).^2);
     k2x2x2y1y1=-(1./2).*sw.*(-(3./2.*(5.*(1+k1).^2.*k2.*k2x2.^2-k1x2.*(1+k1).*((1+k1).*k3+4.*k2.^2+k1+1).*k2x2-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).*k2.*k1x2x2+(3./4.*((1+k1).*k3+(2./3).*k2.^2+k1+1)).*k2.*k1x2.^2+((1+k1).*k3-k2.^2+k1+1).*(1+k1).^2.*k2x2x2)).*(1+k1).^2.*k3y1.^2+2.*(1+k1).^2.*((3.*(1+k1)).*((1+k1).*k3+4.*k2.^2+k1+1).*k2y1.*k2x2.^2+(-9.*k1x2.*((1+k1).*k3+(2./3).*k2.^2+k1+1).*k2.*k2y1-(((1+k1).*k3+2.*k2.^2+k1+1).*k1x2y1-6.*k2x2y1.*k2.*(1+k1)).*((1+k1).*k3-k2.^2+k1+1)).*k2x2+(-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k1).*k3+2.*k2.^2+k1+1).*k1x2x2+(3./4.*((1+k1).*k3+4.*k2.^2+k1+1)).*(1+k3).*k1x2.^2+(3.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).*k2.*k2x2x2).*k2y1+((1+k1).*k3-k2.^2+k1+1).*((3./2).*k2.*k1x2.*(1+k3).*k1x2y1-k1x2.*((1+k1).*k3+2.*k2.^2+k1+1).*k2x2y1+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k2x2x2y1-(1./2).*k2.*k1x2x2y1))).*k3y1-(2.*((9.*((1+k1).*k3+(2./3).*k2.^2+k1+1)).*k2.*k2y1.^2+((1+k1).*k3-k2.^2+k1+1).*(((1+k1).*k3+2.*k2.^2+k1+1).*k2y1y1-(3./2).*k3y1y1.*k2.*(1+k1)))).*(1+k1).^2.*k2x2.^2-(8.*(-(3./4).*k1x2.*((1+k1).*k3+4.*k2.^2+k1+1).*(1+k3).*k2y1.^2+(-(3./2).*k2.*(1+k3).*k1x2y1+k2x2y1.*((1+k1).*k3+2.*k2.^2+k1+1)).*((1+k1).*k3-k2.^2+k1+1).*k2y1+(1./8.*(-6.*k2.*k1x2.*(1+k3).*k2y1y1+k1x2.*((1+k1).*k3+2.*k2.^2+k1+1).*k3y1y1-(2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k3).*k1x2y1y1-2.*k2x2y1y1.*k2))).*((1+k1).*k3-k2.^2+k1+1))).*(1+k1).^2.*k2x2-(2.*(-(3./2.*((1+k1).*k3-k2.^2+k1+1)).*k2.*(1+k3).*k1x2x2+(15./4).*k2.*(1+k3).^2.*k1x2.^2+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k3+2.*k2.^2+k1+1).*k2x2x2)).*(1+k1).^2.*k2y1.^2+(2.*((1+k1).*k3-k2.^2+k1+1)).*(-3.*k1x2.*(1+k3).^2.*k1x2y1+6.*k2.*k1x2.*(1+k3).*k2x2y1+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k1x2x2y1-2.*k2x2x2y1.*k2)).*(1+k1).^2.*k2y1+(-(3.*((1+k1).*k3-k2.^2+k1+1)).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x2y1.^2+(4.*((1+k1).*k3-k2.^2+k1+1)).*k2x2y1.*(1+k1).^2.*(1+k3).*k1x2y1-(4.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).^2.*k2.*k2x2y1.^2-2.*(1+k1).^2.*(-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*(1+k3).*k1x2x2+(3./4).*(1+k3).^2.*k1x2.^2+((1+k1).*k3-k2.^2+k1+1).*k2.*k2x2x2).*k2y1y1-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*k3y1y1.*(1+k1).^2.*k2.*k1x2x2+((3./4).*k2.*(1+k3).*k1x2.^2+((1+k1).*k3-k2.^2+k1+1).*(1+k1).*k2x2x2).*(1+k1).^2.*k3y1y1-(2.*((1+k1).*k3-k2.^2+k1+1)).*(((3./2).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x2y1y1-k2x2y1y1.*(1+k3).*(1+k1).^2).*k1x2+((1+k1).*k2x2x2y1y1-(1./2).*k2.*k1x2x2y1y1).*((1+k1).*k3-k2.^2+k1+1).*(1+k1))).*((1+k1).*k3-k2.^2+k1+1))./(((1+k1).*k3-k2.^2+k1+1).^(7./2).*(1+k1).^2);
     k2x1x1y2y2=-(1./2).*sw.*(-(3./2.*(5.*(1+k1).^2.*k2.*k2x1.^2-k1x1.*(1+k1).*((1+k1).*k3+4.*k2.^2+k1+1).*k2x1-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).*k2.*k1x1x1+(3./4.*((1+k1).*k3+(2./3).*k2.^2+k1+1)).*k2.*k1x1.^2+((1+k1).*k3-k2.^2+k1+1).*(1+k1).^2.*k2x1x1)).*(1+k1).^2.*k3y2.^2+2.*(1+k1).^2.*((3.*(1+k1)).*((1+k1).*k3+4.*k2.^2+k1+1).*k2y2.*k2x1.^2+(-9.*k1x1.*((1+k1).*k3+(2./3).*k2.^2+k1+1).*k2.*k2y2-(((1+k1).*k3+2.*k2.^2+k1+1).*k1x1y2-6.*k2x1y2.*k2.*(1+k1)).*((1+k1).*k3-k2.^2+k1+1)).*k2x1+(-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k1).*k3+2.*k2.^2+k1+1).*k1x1x1+(3./4.*((1+k1).*k3+4.*k2.^2+k1+1)).*(1+k3).*k1x1.^2+(3.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).*k2.*k2x1x1).*k2y2+((1+k1).*k3-k2.^2+k1+1).*((3./2).*k2.*k1x1.*(1+k3).*k1x1y2-k1x1.*((1+k1).*k3+2.*k2.^2+k1+1).*k2x1y2+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k2x1x1y2-(1./2).*k2.*k1x1x1y2))).*k3y2-(2.*((9.*((1+k1).*k3+(2./3).*k2.^2+k1+1)).*k2.*k2y2.^2+((1+k1).*k3-k2.^2+k1+1).*(((1+k1).*k3+2.*k2.^2+k1+1).*k2y2y2-(3./2).*k3y2y2.*k2.*(1+k1)))).*(1+k1).^2.*k2x1.^2-(8.*(-(3./4).*k1x1.*((1+k1).*k3+4.*k2.^2+k1+1).*(1+k3).*k2y2.^2+(-(3./2).*k2.*(1+k3).*k1x1y2+k2x1y2.*((1+k1).*k3+2.*k2.^2+k1+1)).*((1+k1).*k3-k2.^2+k1+1).*k2y2+(1./8.*(-6.*k2.*k1x1.*(1+k3).*k2y2y2+k1x1.*((1+k1).*k3+2.*k2.^2+k1+1).*k3y2y2-(2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k3).*k1x1y2y2-2.*k2x1y2y2.*k2))).*((1+k1).*k3-k2.^2+k1+1))).*(1+k1).^2.*k2x1-(2.*(-(3./2.*((1+k1).*k3-k2.^2+k1+1)).*k2.*(1+k3).*k1x1x1+(15./4).*k2.*(1+k3).^2.*k1x1.^2+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k3+2.*k2.^2+k1+1).*k2x1x1)).*(1+k1).^2.*k2y2.^2+(2.*((1+k1).*k3-k2.^2+k1+1)).*(-3.*k1x1.*(1+k3).^2.*k1x1y2+6.*k2.*k1x1.*(1+k3).*k2x1y2+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k1x1x1y2-2.*k2x1x1y2.*k2)).*(1+k1).^2.*k2y2+(-(3.*((1+k1).*k3-k2.^2+k1+1)).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x1y2.^2+(4.*((1+k1).*k3-k2.^2+k1+1)).*k2x1y2.*(1+k1).^2.*(1+k3).*k1x1y2-(4.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).^2.*k2.*k2x1y2.^2-2.*(1+k1).^2.*(-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*(1+k3).*k1x1x1+(3./4).*(1+k3).^2.*k1x1.^2+((1+k1).*k3-k2.^2+k1+1).*k2.*k2x1x1).*k2y2y2-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*k3y2y2.*(1+k1).^2.*k2.*k1x1x1+((3./4).*k2.*(1+k3).*k1x1.^2+((1+k1).*k3-k2.^2+k1+1).*(1+k1).*k2x1x1).*(1+k1).^2.*k3y2y2-(2.*((1+k1).*k3-k2.^2+k1+1)).*(((3./2).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x1y2y2-k2x1y2y2.*(1+k3).*(1+k1).^2).*k1x1+((1+k1).*k2x1x1y2y2-(1./2).*k2.*k1x1x1y2y2).*((1+k1).*k3-k2.^2+k1+1).*(1+k1))).*((1+k1).*k3-k2.^2+k1+1))./(((1+k1).*k3-k2.^2+k1+1).^(7./2).*(1+k1).^2);
     k2x2x2y2y2=-(1./2).*sw.*(-(3./2.*(5.*(1+k1).^2.*k2.*k2x2.^2-k1x2.*(1+k1).*((1+k1).*k3+4.*k2.^2+k1+1).*k2x2-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).*k2.*k1x2x2+(3./4.*((1+k1).*k3+(2./3).*k2.^2+k1+1)).*k2.*k1x2.^2+((1+k1).*k3-k2.^2+k1+1).*(1+k1).^2.*k2x2x2)).*(1+k1).^2.*k3y2.^2+2.*(1+k1).^2.*((3.*(1+k1)).*((1+k1).*k3+4.*k2.^2+k1+1).*k2y2.*k2x2.^2+(-9.*k1x2.*((1+k1).*k3+(2./3).*k2.^2+k1+1).*k2.*k2y2-(((1+k1).*k3+2.*k2.^2+k1+1).*k1x2y2-6.*k2x2y2.*k2.*(1+k1)).*((1+k1).*k3-k2.^2+k1+1)).*k2x2+(-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k1).*k3+2.*k2.^2+k1+1).*k1x2x2+(3./4.*((1+k1).*k3+4.*k2.^2+k1+1)).*(1+k3).*k1x2.^2+(3.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).*k2.*k2x2x2).*k2y2+((1+k1).*k3-k2.^2+k1+1).*((3./2).*k2.*k1x2.*(1+k3).*k1x2y2-k1x2.*((1+k1).*k3+2.*k2.^2+k1+1).*k2x2y2+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k2x2x2y2-(1./2).*k2.*k1x2x2y2))).*k3y2-(2.*((9.*((1+k1).*k3+(2./3).*k2.^2+k1+1)).*k2.*k2y2.^2+((1+k1).*k3-k2.^2+k1+1).*(((1+k1).*k3+2.*k2.^2+k1+1).*k2y2y2-(3./2).*k3y2y2.*k2.*(1+k1)))).*(1+k1).^2.*k2x2.^2-(8.*(-(3./4).*k1x2.*((1+k1).*k3+4.*k2.^2+k1+1).*(1+k3).*k2y2.^2+(-(3./2).*k2.*(1+k3).*k1x2y2+k2x2y2.*((1+k1).*k3+2.*k2.^2+k1+1)).*((1+k1).*k3-k2.^2+k1+1).*k2y2+(1./8.*(-6.*k2.*k1x2.*(1+k3).*k2y2y2+k1x2.*((1+k1).*k3+2.*k2.^2+k1+1).*k3y2y2-(2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k3).*k1x2y2y2-2.*k2x2y2y2.*k2))).*((1+k1).*k3-k2.^2+k1+1))).*(1+k1).^2.*k2x2-(2.*(-(3./2.*((1+k1).*k3-k2.^2+k1+1)).*k2.*(1+k3).*k1x2x2+(15./4).*k2.*(1+k3).^2.*k1x2.^2+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k3+2.*k2.^2+k1+1).*k2x2x2)).*(1+k1).^2.*k2y2.^2+(2.*((1+k1).*k3-k2.^2+k1+1)).*(-3.*k1x2.*(1+k3).^2.*k1x2y2+6.*k2.*k1x2.*(1+k3).*k2x2y2+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k1x2x2y2-2.*k2x2x2y2.*k2)).*(1+k1).^2.*k2y2+(-(3.*((1+k1).*k3-k2.^2+k1+1)).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x2y2.^2+(4.*((1+k1).*k3-k2.^2+k1+1)).*k2x2y2.*(1+k1).^2.*(1+k3).*k1x2y2-(4.*((1+k1).*k3-k2.^2+k1+1)).*(1+k1).^2.*k2.*k2x2y2.^2-2.*(1+k1).^2.*(-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*(1+k3).*k1x2x2+(3./4).*(1+k3).^2.*k1x2.^2+((1+k1).*k3-k2.^2+k1+1).*k2.*k2x2x2).*k2y2y2-(1./2.*((1+k1).*k3-k2.^2+k1+1)).*k3y2y2.*(1+k1).^2.*k2.*k1x2x2+((3./4).*k2.*(1+k3).*k1x2.^2+((1+k1).*k3-k2.^2+k1+1).*(1+k1).*k2x2x2).*(1+k1).^2.*k3y2y2-(2.*((1+k1).*k3-k2.^2+k1+1)).*(((3./2).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x2y2y2-k2x2y2y2.*(1+k3).*(1+k1).^2).*k1x2+((1+k1).*k2x2x2y2y2-(1./2).*k2.*k1x2x2y2y2).*((1+k1).*k3-k2.^2+k1+1).*(1+k1))).*((1+k1).*k3-k2.^2+k1+1))./(((1+k1).*k3-k2.^2+k1+1).^(7./2).*(1+k1).^2);
    
     
     k2x1x1y1=-(1./2).*sw.*((3.*(((-(2./3).*k1-2./3).*k3-(4./3).*k2.^2-(2./3).*k1-2./3).*k2y1+k2.*(1+k1).*k3y1)).*(1+k1).^2.*k2x1.^2+2.*(1+k1).^2.*(3.*k2.*k1x1.*(1+k3).*k2y1-(1./2.*((1+k1).*k3+2.*k2.^2+k1+1)).*k3y1.*k1x1+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k1x1y1-2.*k2x1y1.*k2)).*k2x1-2.*(1+k1).^2.*((3./4).*(1+k3).^2.*k1x1.^2+(k2x1x1.*k2-(1./2).*k3.*k1x1x1-(1./2).*k1x1x1).*((1+k1).*k3-k2.^2+k1+1)).*k2y1+(3./4).*k2.*k3y1.*(1+k1).^2.*(1+k3).*k1x1.^2+(2.*((1+k1).*k3-k2.^2+k1+1)).*(-(3./2).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x1y1+k2x1y1.*(1+k1).^2.*(1+k3)).*k1x1+((1+k1).*(-(1./2).*k2.*k1x1x1+k2x1x1.*(1+k1)).*k3y1-(2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k1).*k2x1x1y1-(1./2).*k2.*k1x1x1y1)).*((1+k1).*k3-k2.^2+k1+1).*(1+k1))./(((1+k1).*k3-k2.^2+k1+1).^(5./2).*(1+k1).^2);
     k2x2x2y1=-(1./2).*sw.*((3.*(((-(2./3).*k1-2./3).*k3-(4./3).*k2.^2-(2./3).*k1-2./3).*k2y1+k2.*(1+k1).*k3y1)).*(1+k1).^2.*k2x2.^2+2.*(1+k1).^2.*(3.*k2.*k1x2.*(1+k3).*k2y1-(1./2.*((1+k1).*k3+2.*k2.^2+k1+1)).*k3y1.*k1x2+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k1x2y1-2.*k2x2y1.*k2)).*k2x2-2.*(1+k1).^2.*((3./4).*(1+k3).^2.*k1x2.^2+(k2x2x2.*k2-(1./2).*k3.*k1x2x2-(1./2).*k1x2x2).*((1+k1).*k3-k2.^2+k1+1)).*k2y1+(3./4).*k2.*k3y1.*(1+k1).^2.*(1+k3).*k1x2.^2+(2.*((1+k1).*k3-k2.^2+k1+1)).*(-(3./2).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x2y1+k2x2y1.*(1+k1).^2.*(1+k3)).*k1x2+((1+k1).*(-(1./2).*k2.*k1x2x2+k2x2x2.*(1+k1)).*k3y1-(2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k1).*k2x2x2y1-(1./2).*k2.*k1x2x2y1)).*((1+k1).*k3-k2.^2+k1+1).*(1+k1))./(((1+k1).*k3-k2.^2+k1+1).^(5./2).*(1+k1).^2);
     k2x1x1y2=-(1./2).*sw.*((3.*(((-(2./3).*k1-2./3).*k3-(4./3).*k2.^2-(2./3).*k1-2./3).*k2y2+k2.*(1+k1).*k3y2)).*(1+k1).^2.*k2x1.^2+2.*(1+k1).^2.*(3.*k2.*k1x1.*(1+k3).*k2y2-(1./2.*((1+k1).*k3+2.*k2.^2+k1+1)).*k3y2.*k1x1+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k1x1y2-2.*k2x1y2.*k2)).*k2x1-2.*(1+k1).^2.*((3./4).*(1+k3).^2.*k1x1.^2+(k2x1x1.*k2-(1./2).*k3.*k1x1x1-(1./2).*k1x1x1).*((1+k1).*k3-k2.^2+k1+1)).*k2y2+(3./4).*k2.*k3y2.*(1+k1).^2.*(1+k3).*k1x1.^2+(2.*((1+k1).*k3-k2.^2+k1+1)).*(-(3./2).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x1y2+k2x1y2.*(1+k1).^2.*(1+k3)).*k1x1+((1+k1).*(-(1./2).*k2.*k1x1x1+k2x1x1.*(1+k1)).*k3y2-(2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k1).*k2x1x1y2-(1./2).*k2.*k1x1x1y2)).*((1+k1).*k3-k2.^2+k1+1).*(1+k1))./(((1+k1).*k3-k2.^2+k1+1).^(5./2).*(1+k1).^2);
     k2x2x2y2=-(1./2).*sw.*((3.*(((-(2./3).*k1-2./3).*k3-(4./3).*k2.^2-(2./3).*k1-2./3).*k2y2+k2.*(1+k1).*k3y2)).*(1+k1).^2.*k2x2.^2+2.*(1+k1).^2.*(3.*k2.*k1x2.*(1+k3).*k2y2-(1./2.*((1+k1).*k3+2.*k2.^2+k1+1)).*k3y2.*k1x2+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k1x2y2-2.*k2x2y2.*k2)).*k2x2-2.*(1+k1).^2.*((3./4).*(1+k3).^2.*k1x2.^2+(k2x2x2.*k2-(1./2).*k3.*k1x2x2-(1./2).*k1x2x2).*((1+k1).*k3-k2.^2+k1+1)).*k2y2+(3./4).*k2.*k3y2.*(1+k1).^2.*(1+k3).*k1x2.^2+(2.*((1+k1).*k3-k2.^2+k1+1)).*(-(3./2).*k2.*((1+k1).*k3-(2./3).*k2.^2+k1+1).*k1x2y2+k2x2y2.*(1+k1).^2.*(1+k3)).*k1x2+((1+k1).*(-(1./2).*k2.*k1x2x2+k2x2x2.*(1+k1)).*k3y2-(2.*((1+k1).*k3-k2.^2+k1+1)).*((1+k1).*k2x2x2y2-(1./2).*k2.*k1x2x2y2)).*((1+k1).*k3-k2.^2+k1+1).*(1+k1))./(((1+k1).*k3-k2.^2+k1+1).^(5./2).*(1+k1).^2);

     
     k2x1y1y1=-sw.*(-(3./4).*(1+k1).^2.*(-(1./2).*k2.*k1x1+k2x1.*(1+k1)).*k3y1.^2+(-(1./2.*((1+k1).*k3+2.*k2.^2+k1+1)).*k2y1.*k1x1+3.*k2.*k2x1.*(1+k1).*k2y1+((1+k1).*k3-k2.^2+k1+1).*(-(1./2).*k2.*k1x1y1+k2x1y1.*(1+k1))).*(1+k1).*k3y1+(1./2.*(1+k1)).*(3.*k2.*(1+k3).*k2y1.^2+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k2y1y1-(1./2).*k2.*k3y1y1)).*k1x1+(1./2.*(((-2.*k1-2).*k3-4.*k2.^2-2.*k1-2).*k2y1.^2+((1+k1).*k3-k2.^2+k1+1).*(-2.*k2.*k2y1y1+k3y1y1.*(1+k1)))).*(1+k1).*k2x1-((1+k1).*k3-k2.^2+k1+1).*((2.*((-(1./2).*k3-1./2).*k1x1y1+k2x1y1.*k2)).*(1+k1).*k2y1+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k2x1y1y1-(1./2).*k2.*k1x1y1y1)))./(((1+k1).*k3-k2.^2+k1+1).^(5./2).*(1+k1));
     k2x2y1y1=-sw.*(-(3./4).*(1+k1).^2.*(-(1./2).*k2.*k1x2+k2x2.*(1+k1)).*k3y1.^2+(-(1./2.*((1+k1).*k3+2.*k2.^2+k1+1)).*k2y1.*k1x2+3.*k2.*k2x2.*(1+k1).*k2y1+((1+k1).*k3-k2.^2+k1+1).*(-(1./2).*k2.*k1x2y1+k2x2y1.*(1+k1))).*(1+k1).*k3y1+(1./2.*(1+k1)).*(3.*k2.*(1+k3).*k2y1.^2+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k2y1y1-(1./2).*k2.*k3y1y1)).*k1x2+(1./2.*(((-2.*k1-2).*k3-4.*k2.^2-2.*k1-2).*k2y1.^2+((1+k1).*k3-k2.^2+k1+1).*(-2.*k2.*k2y1y1+k3y1y1.*(1+k1)))).*(1+k1).*k2x2-((1+k1).*k3-k2.^2+k1+1).*((2.*((-(1./2).*k3-1./2).*k1x2y1+k2x2y1.*k2)).*(1+k1).*k2y1+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k2x2y1y1-(1./2).*k2.*k1x2y1y1)))./(((1+k1).*k3-k2.^2+k1+1).^(5./2).*(1+k1));
     k2x1y2y2=-sw.*(-(3./4).*(1+k1).^2.*(-(1./2).*k2.*k1x1+k2x1.*(1+k1)).*k3y2.^2+(-(1./2.*((1+k1).*k3+2.*k2.^2+k1+1)).*k2y2.*k1x1+3.*k2.*k2x1.*(1+k1).*k2y2+((1+k1).*k3-k2.^2+k1+1).*(-(1./2).*k2.*k1x1y2+k2x1y2.*(1+k1))).*(1+k1).*k3y2+(1./2.*(1+k1)).*(3.*k2.*(1+k3).*k2y2.^2+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k2y2y2-(1./2).*k2.*k3y2y2)).*k1x1+(1./2.*(((-2.*k1-2).*k3-4.*k2.^2-2.*k1-2).*k2y2.^2+((1+k1).*k3-k2.^2+k1+1).*(-2.*k2.*k2y2y2+k3y2y2.*(1+k1)))).*(1+k1).*k2x1-((1+k1).*k3-k2.^2+k1+1).*((2.*((-(1./2).*k3-1./2).*k1x1y2+k2x1y2.*k2)).*(1+k1).*k2y2+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k2x1y2y2-(1./2).*k2.*k1x1y2y2)))./(((1+k1).*k3-k2.^2+k1+1).^(5./2).*(1+k1));
     k2x2y2y2=-sw.*(-(3./4).*(1+k1).^2.*(-(1./2).*k2.*k1x2+k2x2.*(1+k1)).*k3y2.^2+(-(1./2.*((1+k1).*k3+2.*k2.^2+k1+1)).*k2y2.*k1x2+3.*k2.*k2x2.*(1+k1).*k2y2+((1+k1).*k3-k2.^2+k1+1).*(-(1./2).*k2.*k1x2y2+k2x2y2.*(1+k1))).*(1+k1).*k3y2+(1./2.*(1+k1)).*(3.*k2.*(1+k3).*k2y2.^2+((1+k1).*k3-k2.^2+k1+1).*((1+k3).*k2y2y2-(1./2).*k2.*k3y2y2)).*k1x2+(1./2.*(((-2.*k1-2).*k3-4.*k2.^2-2.*k1-2).*k2y2.^2+((1+k1).*k3-k2.^2+k1+1).*(-2.*k2.*k2y2y2+k3y2y2.*(1+k1)))).*(1+k1).*k2x2-((1+k1).*k3-k2.^2+k1+1).*((2.*((-(1./2).*k3-1./2).*k1x2y2+k2x2y2.*k2)).*(1+k1).*k2y2+((1+k1).*k3-k2.^2+k1+1).*((1+k1).*k2x2y2y2-(1./2).*k2.*k1x2y2y2)))./(((1+k1).*k3-k2.^2+k1+1).^(5./2).*(1+k1));
     
     k2x1x1=sw.*((((1./2).*k1+1./2).*k1x1x1-(1./2).*k1x1.^2).*k2.^3-k2x1x1.*(1+k1).^2.*k2.^2-(1./2.*(1+k1)).*((1+k1).*(1+k3).*k1x1x1+(-(3./2).*k3-3./2).*k1x1.^2-2.*k2x1.^2.*(1+k1)).*k2+(-k1x1.*k2x1+k2x1x1.*(1+k1)).*(1+k1).^2.*(1+k3))./(((1+k1).*k3-k2.^2+k1+1).^(3./2).*(1+k1).^2);
     k2x2x2=sw.*((((1./2).*k1+1./2).*k1x2x2-(1./2).*k1x2.^2).*k2.^3-k2x2x2.*(1+k1).^2.*k2.^2-(1./2.*(1+k1)).*((1+k1).*(1+k3).*k1x2x2+(-(3./2).*k3-3./2).*k1x2.^2-2.*k2x2.^2.*(1+k1)).*k2+(-k1x2.*k2x2+k2x2x2.*(1+k1)).*(1+k1).^2.*(1+k3))./(((1+k1).*k3-k2.^2+k1+1).^(3./2).*(1+k1).^2);
     k2y1y1=-(1./2).*sw.*((1+k3).*((k3y1y1.*(1+k3)-(3./2).*k3y1.^2).*k2-(2.*(-k2y1.*k3y1+(1+k3).*k2y1y1)).*(1+k3)).*k1+((-1-k3).*k3y1y1+k3y1.^2).*k2.^3+2.*k2y1y1.*(1+k3).^2.*k2.^2-(2.*((-(1./2).*k3-1./2).*k3y1y1+(3./4).*k3y1.^2+k2y1.^2.*(1+k3))).*(1+k3).*k2-(2.*(-k2y1.*k3y1+(1+k3).*k2y1y1)).*(1+k3).^2)./(((1+k1).*k3-k2.^2+k1+1).^(3./2).*(1+k3).^2);
     k2y2y2=-(1./2).*sw.*((1+k3).*((k3y2y2.*(1+k3)-(3./2).*k3y2.^2).*k2-(2.*(-k2y2.*k3y2+(1+k3).*k2y2y2)).*(1+k3)).*k1+((-1-k3).*k3y2y2+k3y2.^2).*k2.^3+2.*k2y2y2.*(1+k3).^2.*k2.^2-(2.*((-(1./2).*k3-1./2).*k3y2y2+(3./4).*k3y2.^2+k2y2.^2.*(1+k3))).*(1+k3).*k2-(2.*(-k2y2.*k3y2+(1+k3).*k2y2y2)).*(1+k3).^2)./(((1+k1).*k3-k2.^2+k1+1).^(3./2).*(1+k3).^2);
    
     k2x1y1=sw.*((-(1./2).*k1x1.*k2y1-(1./2).*k2.*k1x1y1+k2x1y1.*(1+k1)).*(1+k1).*k3+(1./4.*(k2.*k3y1-2.*k2y1)).*(1+k1).*k1x1+k2.*k2x1.*(1+k1).*k2y1+(1./2).*k1x1y1.*k2.^3-k2x1y1.*(1+k1).*k2.^2-(1./2).*k1x1y1.*(1+k1).*k2+(-(1./2).*k2x1.*k3y1+k2x1y1).*(1+k1).^2)./(((1+k1).*k3-k2.^2+k1+1).^(3./2).*(1+k1));
     k2x2y1=sw.*((-(1./2).*k1x2.*k2y1-(1./2).*k2.*k1x2y1+k2x2y1.*(1+k1)).*(1+k1).*k3+(1./4.*(k2.*k3y1-2.*k2y1)).*(1+k1).*k1x2+k2.*k2x2.*(1+k1).*k2y1+(1./2).*k1x2y1.*k2.^3-k2x2y1.*(1+k1).*k2.^2-(1./2).*k1x2y1.*(1+k1).*k2+(-(1./2).*k2x2.*k3y1+k2x2y1).*(1+k1).^2)./(((1+k1).*k3-k2.^2+k1+1).^(3./2).*(1+k1));
     k2x1y2=sw.*((-(1./2).*k1x1.*k2y2-(1./2).*k2.*k1x1y2+k2x1y2.*(1+k1)).*(1+k1).*k3+(1./4.*(k2.*k3y2-2.*k2y2)).*(1+k1).*k1x1+k2.*k2x1.*(1+k1).*k2y2+(1./2).*k1x1y2.*k2.^3-k2x1y2.*(1+k1).*k2.^2-(1./2).*k1x1y2.*(1+k1).*k2+(-(1./2).*k2x1.*k3y2+k2x1y2).*(1+k1).^2)./(((1+k1).*k3-k2.^2+k1+1).^(3./2).*(1+k1));
     k2x2y2=sw.*((-(1./2).*k1x2.*k2y2-(1./2).*k2.*k1x2y2+k2x2y2.*(1+k1)).*(1+k1).*k3+(1./4.*(k2.*k3y2-2.*k2y2)).*(1+k1).*k1x2+k2.*k2x2.*(1+k1).*k2y2+(1./2).*k1x2y2.*k2.^3-k2x2y2.*(1+k1).*k2.^2-(1./2).*k1x2y2.*(1+k1).*k2+(-(1./2).*k2x2.*k3y2+k2x2y2).*(1+k1).^2)./(((1+k1).*k3-k2.^2+k1+1).^(3./2).*(1+k1));
   
     
     k2x1=sw.*(2.*k1.*k2x1-k1x1.*k2+2.*k2x1)./(sqrt((1+k1).*k3-k2.^2+k1+1).*(2+2.*k1));
     k2x2=sw.*(2.*k1.*k2x2-k1x2.*k2+2.*k2x2)./(sqrt((1+k1).*k3-k2.^2+k1+1).*(2+2.*k1));
     k2y1=-sw.*((-2.*k3-2).*k2y1+k2.*k3y1)./(sqrt((1+k1).*k3-k2.^2+k1+1).*(2+2.*k3));
     k2y2=-sw.*((-2.*k3-2).*k2y2+k2.*k3y2)./(sqrt((1+k1).*k3-k2.^2+k1+1).*(2+2.*k3));
                    
     k2=var_bias(i)+var_weight(i).*asin(k2./sqrt((1+k1).*(1+k3)));
     
 %%% iteration of variances    
  
     k1x1x1=sw.*(2.*k1x1x1.*k1.^2+(-3.*k1x1.^2+3.*k1x1x1).*k1-2.*k1x1.^2+k1x1x1)./((2.*k1+1).^(3./2).*(1+k1).^2);
     k1x2x2=sw.*(2.*k1x2x2.*k1.^2+(-3.*k1x2.^2+3.*k1x2x2).*k1-2.*k1x2.^2+k1x2x2)./((2.*k1+1).^(3./2).*(1+k1).^2);

     
     k3y1y1=sw.*(2.*k3y1y1.*k3.^2+(-3.*k3y1.^2+3.*k3y1y1).*k3-2.*k3y1.^2+k3y1y1)./((2.*k3+1).^(3./2).*(1+k3).^2);
     k3y2y2=sw.*(2.*k3y2y2.*k3.^2+(-3.*k3y2.^2+3.*k3y2y2).*k3-2.*k3y2.^2+k3y2y2)./((2.*k3+1).^(3./2).*(1+k3).^2);
     
     k1x1=sw.*k1x1./((1+k1).*sqrt(2*k1+1));
     k1x2=sw.*k1x2./((1+k1).*sqrt(2*k1+1));
 
     k3y1=sw.*k3y1./((1+k3).*sqrt(2*k3+1));
     k3y2=sw.*k3y2./((1+k3).*sqrt(2*k3+1));
     
    
     k1=var_bias(i)+sw*asin(k1./(1+k1));
     k3=var_bias(i)+sw*asin(k3./(1+k3));
     
  
 end
 
 k=k2;
 Lapx_k=-(k2x1x1+k2x2x2);
 Lapy_k=-(k2y1y1+k2y2y2);
 LapLap_k=k2x1x1y1y1+k2x1x1y2y2+k2x2x2y1y1+k2x2x2y2y2;

